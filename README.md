# Upload Server

This project is an image upload server built with Node JS using TypeScript.

## Table of Contents

- [Features](#features)
- [Technologies](#technologies)
- [Setup](#setup)
- [Usage](#usage)

## Features

- **Upload an image**
  - Users can upload images to the server, which are stored in Cloudflare R2, while metadata is saved in a PostgreSQL database. The upload process leverages Node.js streams to handle file content efficiently, processing data in chunks instead of loading it all into memory, ensuring better performance and lower resource consumption.
- **Get uploads**:
  - Retrieves a paginated list of uploaded images from the database, supporting optional search and sorting. Users can filter uploads by name, sort by creation date in ascending or descending order, and customize pagination settings such as page number and page size.
- **Export uploads**:
  - Generates a CSV report of uploaded images based on an optional search query and stores it in Cloudflare R2. Uses a database cursor and Node.js streams to efficiently process large datasets, converting records to CSV format and uploading them without loading all data into memory. Returns a URL for downloading the generated report.

## Technologies

- **Fastify**
- **Zod**
- **Swagger**
- **Drizzle**
- **Docker**
- **PostgreSQL**
- **Cloudflare R2**
- **pnpm**
- **TypeScript**
- **GitHub Actions**

## Setup

### Prerequisites

- Node.js (version 20 or higher)
- Docker
- pnpm

### Installation

1. Clone the repository:
   ```sh
   git clone https://github.com/heitorlbelem/upload-server.git
   cd upload-server
   ```
2. Install dependencies:
    ```sh
    pnpm install
    ```
3. Set up environment variables:
    Create a ⚙️ *.env* file in the root directory and add the following variables:
    ```txt
    DATABASE_URL=postgresql://docker:docker@localhost:5432/upload_db
    CLOUDFLARE_R2_ACCESS_KEY=your-access-key
    CLOUDFLARE_R2_SECRET_KEY=your-secret-key
    CLOUDFLARE_R2_BUCKET_NAME=your-bucket-name
    CLOUDFLARE_R2_REGION=your-region
    ```
4. Start Docker containers:
    ```sh
    docker-compose up -d
    ```
5. Run database migrations
    ```sh
    pnpm db:migrate
    ```

### Usage

#### Running the Server
To start the server in development mode, run:
  ```sh
  pnpm dev
  ```
The server will be available, by default, at:

`http://localhost:3333`

The API documentation is automatically generated by Swagger and can be accessed at:
`http://localhost:3333/docs`

#### Scripts
- `pnpm dev`: Start the server in development mode
- `pnpm build`: Build the project
- `pnpm test`: Run tests
- `pnpm db:migrate`: Run database migrations
